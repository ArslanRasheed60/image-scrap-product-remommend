name: CI/CD Pipeline

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.11" # Use the Python version of your project

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: |
          # Add commands to run your tests, if any

      - name: SSH and Update Server
        uses: appleboy/ssh-action@v0.1.4
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: "root"
          password: ${{ secrets.DROPLET_PASSWORD }}
          script: |
            # Stop the existing Gunicorn process
            pkill -f gunicorn
            # Wait a couple of seconds to ensure the process has been killed
            sleep 2
            # Navigate to the project directory
            cd /var/www/app
            # Pull the latest code
            git pull
            # Activate the virtual environment
            source .venv/bin/activate
            # Install any new dependencies
            pip install -r requirements.txt
            # Start the application using Gunicorn with Uvicorn workers and redirect output to a log file
            gunicorn -w 4 -k uvicorn.workers.UvicornWorker main:app --bind 0.0.0.0:8000 --daemon --access-logfile gunicorn-access.log --error-logfile gunicorn-error.log
            # Output the log file paths
            echo "Gunicorn logs: /var/www/app/gunicorn-access.log and /var/www/app/gunicorn-error.log"
